{% extends "base.html" %}

{% block title %}
{{ title }}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>ダッシュボード</h2>
    <hr>

    {# フラッシュメッセージ #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {# 新規記録の追加フォーム（ダッシュボードに直接表示） - この部分は元のコードからそのまま残します #}
    <div class="card mb-4">
        <div class="card-header">
            <h3>新規記録の追加</h3>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('new_record') }}">
                <div class="mb-3">
                    <label for="date" class="form-label">日付</label>
                    {# app.pyのdashboardルートからはtodayを渡していないため、todayは使えない。
                       ここでは、JavaScriptで今日の日付をセットする方式に戻す。
                       ただし、create_record.htmlと同じロジックを共有するなら、
                       app.pyのdashboardルートでもtodayを渡す必要がある。
                       今回は、dashboard.htmlからnew_recordにPOSTするので、
                       GETでのdashboard表示時はtodayがなくても問題ない。
                       create_record.htmlのフォームと同じinputにする。 #}
                    <input type="date" class="form-control" id="date" name="date" required>
                </div>
                <div class="mb-3">
                    <label for="weight" class="form-label">体重 (kg)</label>
                    <input type="number" step="0.01" class="form-control" id="weight" name="weight" placeholder="例: 65.5" required>
                </div>
                <div class="mb-3">
                    <label for="height" class="form-label">身長 (cm) <small class="text-muted">(任意 - BMI計算に使用)</small></label>
                    {# current_user.heightはdashboardルートから渡されているので利用可能 #}
                    <input type="number" step="0.1" class="form-control" id="height" name="height" placeholder="例: 170.0" value="{{ current_user.height if current_user.height else '' }}">
                </div>
                <div class="mb-3">
                    <label for="notes" class="form-label">メモ</label>
                    <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">記録を追加</button>
            </form>
        </div>
    </div>

{# dashboard.html のどこか、例えばグループメンバーリストの上あたりに #}
{% if current_user.role == 'leader' and current_user.group_id %}
    <p class="mt-3">
        <a href="{{ url_for('view_group_member_records') }}" class="btn btn-primary">
            <i class="fas fa-users"></i> メンバーの最新記録を一覧で見る
        </a>
        <a href="{{ url_for('add_member_to_group') }}" class="btn btn-info">
            <i class="fas fa-user-plus"></i> メンバー管理
        </a>
    </p>
{% endif %}

    {# ★★★ここから追加：グループ関連の表示★★★ #}
    {% if is_leader_view %} {# リーダーがメンバーのダッシュボードを見ている場合 #}
        <div class="alert alert-info" role="alert">
            あなたは <strong>{{ current_user.username }}</strong> のダッシュボードを見ています。
            <a href="{{ url_for('dashboard') }}" class="alert-link">自分のダッシュボードに戻る</a>
        </div>
    {% elif current_user.role == 'leader' and leading_group_name %} {# リーダー本人のダッシュボード #}
        <div class="card mb-4">
            <div class="card-header">
                あなたのグループ: {{ leading_group_name }}
            </div>
            <div class="card-body">
                <h4>グループメンバー:</h4>
                {% if group_members %}
                    <ul class="list-group">
                        {% for member in group_members %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ member.username }} ({{ member.email }})
                                <a href="{{ url_for('view_member_dashboard', user_id=member.id) }}" class="btn btn-info btn-sm">実績を見る</a>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>まだグループメンバーがいません。メンバーを招待しましょう！</p>
                {% endif %}
                <a href="{{ url_for('add_member_to_group') }}" class="btn btn-primary btn-sm mt-3">メンバーを追加/管理</a>
            </div>
        </div>
    {% elif current_user.group_id %} {# リーダーではないがグループに所属しているメンバーの場合 #}
        <div class="alert alert-info" role="alert">
            あなたはグループ "<strong>{{ current_user.group.name }}</strong>" に所属しています。
        </div>
    {% else %} {# どのグループにも所属していない場合 #}
        <div class="alert alert-warning" role="alert">
            まだどのグループにも所属していません。<a href="{{ url_for('new_group') }}" class="alert-link">新しいグループを作成</a>できます。
        </div>
    {% endif %}
    {# ★★★ここまで追加★★★ #}


    {# 健康記録の表示テーブル - この部分は元のコードからそのまま残します #}
    <div class="card mb-4">
        <div class="card-header">
            <h3>あなたの健康記録</h3>
        </div>
        <div class="card-body">
            {% if records %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>日付</th>
                            <th>体重 (kg)</th>
                            <th>身長 (cm)</th> {# 身長も表示するよう追加しました #}
                            <th>BMI</th>
                            <th>メモ</th>
                            <th>アクション</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                        <tr>
                            <td>{{ record.date | date }}</td>
                            <td>{{ record.weight }}</td>
                            <td>{{ record.height if record.height is not none else '-' }}</td> {# 身長も表示 #}
                            <td>{{ record.bmi if record.bmi is not none else 'N/A' }}</td>
                            <td>{{ record.notes if record.notes else 'なし' }}</td>
                            <td>
                                <a href="{{ url_for('edit_record', record_id=record.id) }}" class="btn btn-info btn-sm">編集</a>
                                <form action="{{ url_for('delete_record', record_id=record.id) }}" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('本当にこの記録を削除しますか？');">削除</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>まだ健康記録がありません。上のフォームから最初の記録を追加しましょう！</p>
            {% endif %}
        </div>
    </div>

    {# グラフ表示 - この部分は元のコードからそのまま残します #}
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h3>体重の推移</h3>
                </div>
                <div class="card-body">
                    {% if weight_graph_html %}
                        {{ weight_graph_html | safe }}
                    {% else %}
                        <p>体重の記録が不足しているため、グラフを表示できません。</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h3>BMIの推移</h3>
                </div>
                <div class="card-body">
                    {% if bmi_graph_html %}
                        {{ bmi_graph_html | safe }}
                    {% else %}
                        <p>BMIの記録が不足しているため、グラフを表示できません。</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{# JavaScriptで日付入力フィールドに今日の日付をセットする - この部分もそのまま残します #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        const year = today.getFullYear();
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        const day = today.getDate().toString().padStart(2, '0');
        const dateInput = document.getElementById('date');
        if (dateInput) {
            dateInput.value = `${year}-${month}-${day}`;
        }
    });
</script>
{% endblock %}